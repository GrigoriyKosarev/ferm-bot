"""
–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥ /start —Ç–∞ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é

–§—É–Ω–∫—Ü—ñ—ó:
- –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
- –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
- –ö–æ–º–∞–Ω–¥–∞ /help
"""
from aiogram import Router, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from loguru import logger

from core.keyboards.reply import get_main_menu, get_back_button
from core.database.database import AsyncSessionLocal
from core.database.queries import create_or_update_user, get_cart_summary
# from core.services.weather.service import weather_service
# from core.database.queries_weather import get_user_location


# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ—É—Ç–µ—Ä–∞ –¥–ª—è —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è
router = Router(name="start")


# ============= –ö–û–ú–ê–ù–î–ê /START =============

@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    """
    –û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥–∏ /start

    1. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∞–±–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –ë–î
    2. –û—á–∏—â–µ–Ω–Ω—è FSM —Å—Ç–∞–Ω—É (—è–∫—â–æ –±—É–≤)
    3. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    4. –ü–æ–∫–∞–∑ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
    """
    # –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞–Ω—É FSM
    await state.clear()

    # –†–æ–±–æ—Ç–∞ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö
    async with AsyncSessionLocal() as session:
        # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        user = await create_or_update_user(
            session=session,
            user_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name
        )

        logger.info(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user.user_id} (@{user.username}) –∑–∞–ø—É—Å—Ç–∏–≤ –±–æ—Ç–∞")

    # –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø—Ä–∏–≤—ñ—Ç–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
    user_name = message.from_user.first_name or "–¥—Ä—É–∂–µ"

    welcome_text = (
        f"üåæ <b>–í—ñ—Ç–∞—î–º–æ –≤ FERM Bot!</b>\n\n"
        f"–ü—Ä–∏–≤—ñ—Ç, {user_name}! üëã\n\n"
        f"–Ø –≤–∞—à –æ—Å–æ–±–∏—Å—Ç–∏–π <b>–∞–≥—Ä–æ–ø–æ–º—ñ—á–Ω–∏–∫</b>, —è–∫–∏–π –¥–æ–ø–æ–º–æ–∂–µ:\n\n"
        f"üõí <b>–ü—ñ–¥—ñ–±—Ä–∞—Ç–∏ —Ç–æ–≤–∞—Ä–∏</b>\n"
        f"   ‚Ä¢ –ù–∞—Å—ñ–Ω–Ω—è –ø—Ä–µ–º—ñ—É–º —è–∫–æ—Å—Ç—ñ\n"
        f"   ‚Ä¢ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ –¥–æ–±—Ä–∏–≤–∞\n"
        f"   ‚Ä¢ –ó–∞—Å–æ–±–∏ –∑–∞—Ö–∏—Å—Ç—É —Ä–æ—Å–ª–∏–Ω\n\n"
        f"üå§ <b>–û—Ç—Ä–∏–º–∞—Ç–∏ –∞–≥—Ä–æ–ø–æ–≥–æ–¥—É</b>\n"
        f"   ‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω—ñ–≤\n"
        f"   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è —Ä–æ–±—ñ—Ç\n"
        f"   ‚Ä¢ –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —Ä–∏–∑–∏–∫–∏\n\n"
        f"üí° <b>–ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞—Ç–∏—Å—è –∑ –®–Ü</b>\n"
        f"   ‚Ä¢ –ü—ñ–¥–±—ñ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏—Ö —Ä—ñ—à–µ–Ω—å\n"
        f"   ‚Ä¢ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–æ—Ä–º –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\n"
        f"   ‚Ä¢ –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è\n\n"
        f"üí∞ <b>–ó–Ω–∞–π—Ç–∏ —Ñ—ñ–Ω–∞–Ω—Å—É–≤–∞–Ω–Ω—è</b>\n"
        f"   ‚Ä¢ –ê–∫—Ç—É–∞–ª—å–Ω—ñ –≥—Ä–∞–Ω—Ç–∏\n"
        f"   ‚Ä¢ –î–æ–ø–æ–º–æ–≥–∞ –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ñ\n\n"
        f"üöú <b>–û—Ä–µ–Ω–¥—É–≤–∞—Ç–∏ —Ç–µ—Ö–Ω—ñ–∫—É</b>\n"
        f"   ‚Ä¢ –®–≤–∏–¥–∫–∞ –∑–∞—è–≤–∫–∞\n"
        f"   ‚Ä¢ –®–∏—Ä–æ–∫–∏–π –≤–∏–±—ñ—Ä\n\n"
        f"<i>–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª —É –º–µ–Ω—é –Ω–∏–∂—á–µ</i> üëá"
    )

    # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –≥–æ–ª–æ–≤–Ω–∏–º –º–µ–Ω—é
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu()
    )


# ============= –ö–û–ú–ê–ù–î–ê /HELP =============

@router.message(Command("help"))
async def cmd_help(message: Message):
    """
    –û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥–∏ /help

    –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –¥–æ–≤—ñ–¥–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –±–æ—Ç–∞
    """
    help_text = (
        "<b>‚ÑπÔ∏è –î–æ–≤—ñ–¥–∫–∞ –ø–æ FERM Bot</b>\n\n"
        "<b>üìã –ö–æ–º–∞–Ω–¥–∏:</b>\n"
        "/start - –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é\n"
        "/help - –¶—è –¥–æ–≤—ñ–¥–∫–∞\n"
        "/menu - –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –º–µ–Ω—é\n\n"
        "<b>üõí –Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è –∫–∞—Ç–∞–ª–æ–≥–æ–º:</b>\n"
        "1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å \"üõí –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤\"\n"
        "2. –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é (–ù–∞—Å—ñ–Ω–Ω—è, –î–æ–±—Ä–∏–≤–∞, –ó–ó–†)\n"
        "3. –û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é\n"
        "4. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ç–æ–≤–∞—Ä–∏\n"
        "5. –î–æ–¥–∞–π—Ç–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ –∫–æ—à–∏–∫–∞\n\n"
        "<b>üìä –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–æ—Ä–º:</b>\n"
        "–ü—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ —Ç–æ–≤–∞—Ä—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å \"üìä –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –Ω–æ—Ä–º—É\"\n"
        "–í–≤–µ–¥—ñ—Ç—å –ø–ª–æ—â—É –≤–∞—à–æ–≥–æ –≥–æ—Å–ø–æ–¥–∞—Ä—Å—Ç–≤–∞\n"
        "–û—Ç—Ä–∏–º–∞–π—Ç–µ —Ç–æ—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ\n\n"
        "<b>üí° –®–Ü-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç:</b>\n"
        "–ü–æ—Å—Ç–∞–≤—Ç–µ –±—É–¥—å-—è–∫–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ:\n"
        "‚Ä¢ –í–∏–±—ñ—Ä –Ω–∞—Å—ñ–Ω–Ω—è –¥–ª—è –≤–∞—à–æ—ó –∫—É–ª—å—Ç—É—Ä–∏\n"
        "‚Ä¢ –ü—ñ–¥–±—ñ—Ä –¥–æ–±—Ä–∏–≤ —ñ –ó–ó–†\n"
        "‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—é –≤–∏—Ä–æ—â—É–≤–∞–Ω–Ω—è\n"
        "‚Ä¢ –ë–æ—Ä–æ—Ç—å–±—É –∑ —à–∫—ñ–¥–Ω–∏–∫–∞–º–∏ —Ç–∞ —Ö–≤–æ—Ä–æ–±–∞–º–∏\n\n"
        "<b>üå§ –ê–≥—Ä–æ–ü–æ–≥–æ–¥–∞:</b>\n"
        "‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω—ñ–≤\n"
        "‚Ä¢ –ê–≥—Ä–æ—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –Ω–∞ –¥–µ–Ω—å\n"
        "‚Ä¢ –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ —â–æ–¥–µ–Ω–Ω—ñ —Ä–æ–∑—Å–∏–ª–∫–∏\n\n"
        "<b>üí∞ –ê–≥—Ä–æ–ì—Ä–∞–Ω—Ç–∏:</b>\n"
        "‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–¥ –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º\n"
        "‚Ä¢ –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –æ–Ω–ª–∞–π–Ω\n"
        "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö\n\n"
        "<b>üöú –ê–≥—Ä–æ–£–∫–ª–æ–Ω (–û—Ä–µ–Ω–¥–∞ —Ç–µ—Ö–Ω—ñ–∫–∏):</b>\n"
        "‚Ä¢ –ö–∞—Ç–∞–ª–æ–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—ó —Ç–µ—Ö–Ω—ñ–∫–∏\n"
        "‚Ä¢ –®–≤–∏–¥–∫–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ—Ä–µ–Ω–¥—É\n"
        "‚Ä¢ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ\n\n"
        "<b>üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</b>\n"
        "üìß Email: admin@ferm.in.ua\n"
        "üí¨ Telegram: @ferm_support\n"
        "üåê –°–∞–π—Ç: ferm.in.ua\n\n"
        "<i>–Ø–∫—â–æ –≤–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è - –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—å!</i>"
    )

    await message.answer(help_text)


# ============= –ö–ù–û–ü–ö–ê "–ö–ê–¢–ê–õ–û–ì –¢–û–í–ê–†–Ü–í" =============

@router.message(F.text == "üõí –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤")
async def show_catalog(message: Message):
    """–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–∞–ª–æ–≥—É —Ç–æ–≤–∞—Ä—ñ–≤"""
    from core.database.queries import get_root_categories

    async with AsyncSessionLocal() as session:
        categories = await get_root_categories(session)

        if not categories:
            await message.answer(
                "üòî <b>–ö–∞—Ç–∞–ª–æ–≥ –ø–æ—Ä–æ–∂–Ω—ñ–π</b>\n\n"
                "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —â–µ –Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞."
            )
            return

        from core.keyboards.inline import get_categories_keyboard_from_db

        text = (
            "<b>üõí –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤ FERM</b>\n\n"
            "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ç–æ–≤–∞—Ä—ñ–≤:"
        )

        await message.answer(
            text,
            reply_markup=get_categories_keyboard_from_db(categories)
        )


# ============= –ö–ù–û–ü–ö–ê "–ê–ì–†–û–ü–û–ì–û–î–ê" =============

@router.message(F.text == "üå§ –ê–≥—Ä–æ–ü–æ–≥–æ–¥–∞")
async def show_weather_menu(message: Message):
    """–ú–µ–Ω—é –ê–≥—Ä–æ–ü–æ–≥–æ–¥–∏:
    - –Ø–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –ª–æ–∫–∞—Ü—ñ—è ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω—É –ø–æ–≥–æ–¥—É
    - –Ø–∫—â–æ –Ω–µ–º–∞—î ‚Üí –ø—Ä–æ—Å–∏–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–≤–µ—Å—Ç–∏ –º—ñ—Å—Ç–æ
    """

    user_id = message.from_user.id

    async with AsyncSessionLocal() as session:
        user_location = await get_user_location(session, user_id)

    # –õ–æ–∫–∞—Ü—ñ—è –ù–ï –ó–ê–î–ê–ù–ê ‚Äî –ø—Ä–æ—Å–∏–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–≤–µ—Å—Ç–∏ –º—ñ—Å—Ç–æ
    if not user_location or not user_location.saved_location:
        text = (
            "<b>üå§ –ê–≥—Ä–æ–ü–æ–≥–æ–¥–∞</b>\n\n"
            "üìç –í–∏ —â–µ –Ω–µ –≤–∫–∞–∑–∞–ª–∏ –ª–æ–∫–∞—Ü—ñ—é.\n"
            "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–∞—à–æ–≥–æ –º—ñ—Å—Ç–∞:\n\n"
            "–ù–∞–ø—Ä–∏–∫–ª–∞–¥: <i>–ö–∏—ó–≤, –õ—å–≤—ñ–≤, –ü–æ–ª—Ç–∞–≤–∞, –•–∞—Ä–∫—ñ–≤</i>\n\n"
            "–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –±–æ—Ç –±—É–¥–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ *—Ç–∞ –∞–≥—Ä–æ—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó*."
        )
        return await message.answer(text)

    # –Ø–∫—â–æ –ª–æ–∫–∞—Ü—ñ—è –í–ñ–ï —î ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≥–æ–¥—É
    city = user_location.saved_location
    lat = user_location.latitude
    lon = user_location.longitude
    loc_key = user_location.location_key

    try:
        weather = await weather_service.get_weather(lat, lon, loc_key)
        forecast = await weather_service.get_forecast(lat, lon, loc_key)
        agro = weather_service.get_agro_recommendation(weather)
    except Exception as e:
        return await message.answer(
            "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥–∏. "
            "–ú–æ–∂–ª–∏–≤–æ, –ø—Ä–æ–±–ª–µ–º–∏ –∑ API AccuWeather."
        )

    # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    weather_text = (
        f"<b>üå§ –ü–æ–≥–æ–¥–∞ –¥–ª—è {city}</b>\n\n"
        f"{weather['emoji']} <b>{weather['temp']}¬∞C</b>\n"
        f"–í–æ–ª–æ–≥—ñ—Å—Ç—å: {weather['humidity']}%\n"
        f"–û–ø–∞–¥–∏: {weather['precip']} –º–º\n"
        f"–í—ñ—Ç–µ—Ä: {weather['wind']} –º/—Å\n\n"
        f"<b>üåæ –ê–≥—Ä–æ—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:</b>\n"
        f"{agro}\n\n"
        f"<b>üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—ñ:</b>\n"
    )

    for day in forecast[:3]:
        weather_text += (
            f"{day['emoji']} <b>{day['day']}</b>\n"
            f"{day['min']}¬∞ / {day['max']}¬∞\n"
            f"–û–ø–∞–¥–∏: {day['precip']} –º–º\n\n"
        )

    await message.answer(weather_text)


# ============= –ö–ù–û–ü–ö–ê "–ö–û–ù–°–£–õ–¨–¢–ê–¶–Ü–Ø –®–Ü" =============

@router.message(F.text == "üí° –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –®–Ü")
async def show_consultation_menu(message: Message):
    """
    –ú–µ–Ω—é –®–Ü-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

    –ü–æ—è—Å–Ω—é—î —è–∫ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è
    """
    consultation_text = (
        "<b>üí° –®–Ü-–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç FERM</b>\n\n"
        "–ó–∞–¥–∞–π—Ç–µ –º–µ–Ω—ñ –±—É–¥—å-—è–∫–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ:\n\n"
        "üåæ <b>–ü—ñ–¥–±—ñ—Ä –Ω–∞—Å—ñ–Ω–Ω—è:</b>\n"
        "   ‚Ä¢ –Ø–∫–∏–π —Å–æ—Ä—Ç –æ–±—Ä–∞—Ç–∏ –¥–ª—è –º–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É?\n"
        "   ‚Ä¢ –Ø–∫—ñ —Ç–µ—Ä–º—ñ–Ω–∏ —Å—ñ–≤–±–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ñ?\n"
        "   ‚Ä¢ –Ø–∫–∞ –≤—Ä–æ–∂–∞–π–Ω—ñ—Å—Ç—å –æ—á—ñ–∫—É—î—Ç—å—Å—è?\n\n"
        "üß™ <b>–î–æ–±—Ä–∏–≤–∞ —Ç–∞ –∂–∏–≤–ª–µ–Ω–Ω—è:</b>\n"
        "   ‚Ä¢ –Ø–∫—ñ –¥–æ–±—Ä–∏–≤–∞ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –º–æ—î—ó –∫—É–ª—å—Ç—É—Ä–∏?\n"
        "   ‚Ä¢ –°–∫—ñ–ª—å–∫–∏ –¥–æ–±—Ä–∏–≤ –≤–Ω–µ—Å—Ç–∏ –Ω–∞ 100 –≥–∞?\n"
        "   ‚Ä¢ –ö–æ–ª–∏ –∫—Ä–∞—â–µ –≤–Ω–æ—Å–∏—Ç–∏?\n\n"
        "üõ° <b>–ó–∞—Ö–∏—Å—Ç —Ä–æ—Å–ª–∏–Ω:</b>\n"
        "   ‚Ä¢ –Ø–∫ –±–æ—Ä–æ—Ç–∏—Å—è –∑ —à–∫—ñ–¥–Ω–∏–∫–∞–º–∏?\n"
        "   ‚Ä¢ –Ø–∫—ñ –ó–ó–† –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—Ä–æ—Ç–∏ —Ö–≤–æ—Ä–æ–±?\n"
        "   ‚Ä¢ –ß–∏ –º–æ–∂–Ω–∞ –∑–º—ñ—à—É–≤–∞—Ç–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏?\n\n"
        "üìä <b>–†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏:</b>\n"
        "   ‚Ä¢ –ù–æ—Ä–º–∏ –≤–∏—Å—ñ–≤—É\n"
        "   ‚Ä¢ –ù–æ—Ä–º–∏ –≤–Ω–µ—Å–µ–Ω–Ω—è –¥–æ–±—Ä–∏–≤\n"
        "   ‚Ä¢ –í–∏—Ç—Ä–∞—Ç–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ñ–≤\n\n"
        "<i>–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –æ–ø–∏—à—ñ—Ç—å —Å–∏—Ç—É–∞—Ü—ñ—é</i> üëá\n\n"
        "<i>–†–æ–∑–¥—ñ–ª –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ. –ü–æ—Ç—Ä–µ–±—É—î API –∫–ª—é—á OpenAI.</i>"
    )

    await message.answer(consultation_text)


# ============= –ö–ù–û–ü–ö–ê "–ê–ì–†–û–ì–†–ê–ù–¢–ò" =============

@router.message(F.text == "üí∞ –ê–≥—Ä–æ–ì—Ä–∞–Ω—Ç–∏")
async def show_grants_menu(message: Message):
    """
    –ú–µ–Ω—é –ê–≥—Ä–æ–ì—Ä–∞–Ω—Ç—ñ–≤

    –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –æ–ø—Ü—ñ—ó –≥—Ä–∞–Ω—Ç–æ–≤–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
    """
    from core.keyboards.inline import get_grants_menu_keyboard

    grants_text = (
        "<b>üí∞ –ê–≥—Ä–æ–ì—Ä–∞–Ω—Ç–∏ - –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ñ–µ—Ä–º–µ—Ä—ñ–≤</b>\n\n"
        "–î–æ–ø–æ–º–æ–∂–µ–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥—Ä–∞–Ω—Ç –Ω–∞ —Ä–æ–∑–≤–∏—Ç–æ–∫ –≤–∞—à–æ–≥–æ –≥–æ—Å–ø–æ–¥–∞—Ä—Å—Ç–≤–∞!\n\n"
        "<b>–©–æ –º–∏ –ø—Ä–æ–ø–æ–Ω—É—î–º–æ:</b>\n\n"
        "üìã <b>–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É</b>\n"
        "   –®–≤–∏–¥–∫–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏ –æ–Ω–ª–∞–π–Ω\n\n"
        "üìö <b>–ê–∫—Ç—É–∞–ª—å–Ω—ñ –ø—Ä–æ–≥—Ä–∞–º–∏</b>\n"
        "   –°–ø–∏—Å–æ–∫ –¥—ñ—é—á–∏—Ö –≥—Ä–∞–Ω—Ç–æ–≤–∏—Ö –ø—Ä–æ–≥—Ä–∞–º\n\n"
        "üíº <b>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è</b>\n"
        "   –î–æ–ø–æ–º–æ–≥–∞ –≤ –ø—ñ–¥–≥–æ—Ç–æ–≤—Ü—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤\n\n"
        "üîî <b>–ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤–∏–Ω–∏</b>\n"
        "   –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤—ñ –≥—Ä–∞–Ω—Ç–∏\n\n"
        "<b>üìä –ü–æ–ø—É–ª—è—Ä–Ω—ñ –Ω–∞–ø—Ä—è–º–∏:</b>\n"
        "‚Ä¢ –ü—Ä–∏–¥–±–∞–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è\n"
        "‚Ä¢ –ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ —Ç–∞ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è\n"
        "‚Ä¢ –ó–∞–∫—É–ø—ñ–≤–ª—è –Ω–∞—Å—ñ–Ω–Ω—è —Ç–∞ –¥–æ–±—Ä–∏–≤\n"
        "‚Ä¢ –†–æ–∑–≤–∏—Ç–æ–∫ —Ç–≤–∞—Ä–∏–Ω–Ω–∏—Ü—Ç–≤–∞\n"
        "‚Ä¢ –û—Ä–≥–∞–Ω—ñ—á–Ω–µ –∑–µ–º–ª–µ—Ä–æ–±—Å—Ç–≤–æ\n\n"
        "<i>–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é –∑ –º–µ–Ω—é –Ω–∏–∂—á–µ:</i>"
    )

    await message.answer(
        grants_text,
        reply_markup=get_grants_menu_keyboard()
    )


# ============= –ö–ù–û–ü–ö–ê "–ê–ì–†–û–£–ö–õ–û–ù" =============

@router.message(F.text == "üöú –ê–≥—Ä–æ–£–∫–ª–æ–Ω")
async def show_equipment_menu(message: Message):
    """
    –ú–µ–Ω—é –æ—Ä–µ–Ω–¥–∏ —Ç–µ—Ö–Ω—ñ–∫–∏ (–ê–≥—Ä–æ–£–∫–ª–æ–Ω)

    –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –æ–ø—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏
    """
    from core.keyboards.inline import get_equipment_menu_keyboard

    equipment_text = (
        "<b>üöú –ê–≥—Ä–æ–£–∫–ª–æ–Ω - –ü—Ä–æ—Å—Ç–∞ –æ—Ä–µ–Ω–¥–∞ —Ç–µ—Ö–Ω—ñ–∫–∏</b>\n\n"
        "–û—Ä–µ–Ω–¥—É–π—Ç–µ —Å—ñ–ª—å—Å—å–∫–æ–≥–æ—Å–ø–æ–¥–∞—Ä—Å—å–∫—É —Ç–µ—Ö–Ω—ñ–∫—É —à–≤–∏–¥–∫–æ —Ç–∞ –≤–∏–≥—ñ–¥–Ω–æ!\n\n"
        "<b>üì¶ –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞:</b>\n\n"
        "üöú <b>–¢—Ä–∞–∫—Ç–æ—Ä–∏</b>\n"
        "   –í—ñ–¥ 50 –¥–æ 300 –∫.—Å.\n\n"
        "üåæ <b>–ö–æ–º–±–∞–π–Ω–∏</b>\n"
        "   –ó–µ—Ä–Ω–æ–∑–±–∏—Ä–∞–ª—å–Ω—ñ, –∫—É–∫—É—Ä—É–¥–∑—è–Ω—ñ\n\n"
        "üíß <b>–û–±–ø—Ä–∏—Å–∫—É–≤–∞—á—ñ</b>\n"
        "   –°–∞–º–æ—Ö—ñ–¥–Ω—ñ —Ç–∞ –ø—Ä–∏—á—ñ–ø–Ω—ñ\n\n"
        "üå± <b>–°—ñ–≤–∞–ª–∫–∏</b>\n"
        "   –ü–Ω–µ–≤–º–∞—Ç–∏—á–Ω—ñ, –º–µ—Ö–∞–Ω—ñ—á–Ω—ñ\n\n"
        "üîß <b>–Ü–Ω—à–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</b>\n"
        "   –ö—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä–∏, –ø–ª—É–≥–∏, –±–æ—Ä–æ–Ω–∏\n\n"
        "<b>‚úÖ –ü–µ—Ä–µ–≤–∞–≥–∏:</b>\n"
        "‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞ –≤ —Å–ø—Ä–∞–≤–Ω–æ–º—É —Å—Ç–∞–Ω—ñ\n"
        "‚Ä¢ –ì–Ω—É—á–∫—ñ —É–º–æ–≤–∏ –æ—Ä–µ–Ω–¥–∏\n"
        "‚Ä¢ –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏\n"
        "‚Ä¢ –¢–µ—Ö–Ω—ñ—á–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞\n\n"
        "<i>–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:</i>"
    )

    await message.answer(
        equipment_text,
        reply_markup=get_equipment_menu_keyboard()
    )


# ============= –ö–ù–û–ü–ö–ê "–ö–û–®–ò–ö" =============

@router.message(F.text == "üõç –ö–æ—à–∏–∫")
async def show_cart(message: Message):
    """
    –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—à–∏–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

    –ü–æ–∫–∞–∑—É—î —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤, —Å—É–º—É, –∫–Ω–æ–ø–∫–∏ –¥—ñ–π
    """
    async with AsyncSessionLocal() as session:
        # –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥—Å—É–º–æ–∫ –∫–æ—à–∏–∫–∞
        cart_data = await get_cart_summary(session, message.from_user.id)

        if cart_data['total_items'] == 0:
            # –ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π
            cart_text = (
                "<b>üõç –í–∞—à –∫–æ—à–∏–∫</b>\n\n"
                "–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π ü§∑‚Äç‚ôÇÔ∏è\n\n"
                "–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ <b>üõí –ö–∞—Ç–∞–ª–æ–≥—É —Ç–æ–≤–∞—Ä—ñ–≤</b>,\n"
                "—â–æ–± –¥–æ–¥–∞—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ç–æ–≤–∞—Ä–∏."
            )
            await message.answer(cart_text)
        else:
            # –§–æ—Ä–º—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä—ñ–≤
            items_text = ""
            for idx, item in enumerate(cart_data['items'], 1):
                items_text += (
                    f"{idx}. <b>{item.product_name}</b>\n"
                    f"   üí∞ {item.product_price} –≥—Ä–Ω √ó {item.quantity} {item.unit}\n"
                    f"   = {item.product_price * item.quantity:.2f} –≥—Ä–Ω\n\n"
                )

            cart_text = (
                f"<b>üõç –í–∞—à –∫–æ—à–∏–∫</b>\n\n"
                f"{items_text}"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"<b>üì¶ –¢–æ–≤–∞—Ä—ñ–≤:</b> {cart_data['total_items']} —à—Ç.\n"
                f"<b>üí∞ –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</b> {cart_data['total_price']:.2f} –≥—Ä–Ω\n\n"
                f"<i>–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ–∫—É–ø–∫–∏ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ —Å–∞–π—Ç</i>"
            )

            from core.keyboards.inline import get_cart_actions_keyboard
            await message.answer(
                cart_text,
                reply_markup=get_cart_actions_keyboard()
            )


# ============= –ö–ù–û–ü–ö–ê "–î–û–ü–û–ú–û–ì–ê" =============

@router.message(F.text == "‚ÑπÔ∏è –î–æ–ø–æ–º–æ–≥–∞")
async def show_help(message: Message):
    """
    –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–≤—ñ–¥–∫–∏ (–¥—É–±–ª—é—î /help)
    """
    await cmd_help(message)


# ============= –ö–ù–û–ü–ö–ê "–ù–ê–ó–ê–î –î–û –ú–ï–ù–Æ" =============

@router.message(F.text == "‚óÄÔ∏è –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é")
async def back_to_menu(message: Message, state: FSMContext):
    """
    –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é

    –û—á–∏—â–∞—î FSM —Å—Ç–∞–Ω
    """
    await state.clear()

    menu_text = (
        "<b>üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</b>\n\n"
        "–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª:"
    )

    await message.answer(
        menu_text,
        reply_markup=get_main_menu()
    )


# ============= –ù–ï–í–Ü–î–û–ú–ê –ö–û–ú–ê–ù–î–ê =============

@router.message()
async def unknown_message(message: Message):
    """
    –û–±—Ä–æ–±–∫–∞ –Ω–µ–≤—ñ–¥–æ–º–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

    –ü–æ–∫–∞–∑—É—î –ø—ñ–¥–∫–∞–∑–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    """
    unknown_text = (
        "ü§î –ù–µ –∑—Ä–æ–∑—É–º—ñ–≤ –≤–∞—à–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.\n\n"
        "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∞–±–æ –∫–æ–º–∞–Ω–¥–∏:\n"
        "/start - –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é\n"
        "/help - –î–æ–≤—ñ–¥–∫–∞\n\n"
        "–ê–±–æ –∑–∞–¥–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –≤ —Ä–æ–∑–¥—ñ–ª—ñ <b>üí° –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –®–Ü</b>"
    )

    await message.answer(unknown_text)