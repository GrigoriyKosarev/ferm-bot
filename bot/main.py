"""
–ö–†–û–ö 2: Telegram –±–æ—Ç –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é —á–µ—Ä–µ–∑ .env

–©–æ –Ω–æ–≤–æ–≥–æ –≤ —Ü—å–æ–º—É –∫—Ä–æ—Ü—ñ:
- ‚úÖ –¢–æ–∫–µ–Ω –±—ñ–ª—å—à–µ –ù–ï –≤ –∫–æ–¥—ñ (–±–µ–∑–ø–µ—á–Ω–æ!)
- ‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤–∏–Ω–µ—Å–µ–Ω–∞ –≤ .env —Ñ–∞–π–ª
- ‚úÖ Pydantic –≤–∞–ª—ñ–¥—É—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- ‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–º–∏–ª–∫–∏ —è–∫—â–æ —â–æ—Å—å –Ω–µ —Ç–∞–∫

–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫—É:
1. –§–∞–π–ª .env –∑ BOT_TOKEN (—Å—Ç–≤–æ—Ä—ñ—Ç—å –∑ .env.example)
2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π aiogram —Ç–∞ pydantic-settings (—î –≤ pyproject.toml)

–Ø–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–∏:
    python -m bot.main

–ü–æ—è—Å–Ω–µ–Ω–Ω—è –∫–æ–¥—É:
- asyncio - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
- Bot, Dispatcher - –æ—Å–Ω–æ–≤–∞ aiogram
- settings - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑ config.py (—á–∏—Ç–∞—î .env)
"""

import asyncio
from aiogram import Bot, Dispatcher
from aiogram.filters import CommandStart
from aiogram.types import Message

# –ö–†–û–ö 2: –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
from bot.config import settings


# ========================================
# –ö–†–û–ö 2: –¢–æ–∫–µ–Ω —Ç–µ–ø–µ—Ä –∑ .env —Ñ–∞–π–ª—É!
# ========================================
# –ë—ñ–ª—å—à–µ –Ω–µ –ø–∏—à–µ–º–æ —Ç–æ–∫–µ–Ω –≤ –∫–æ–¥—ñ!
# settings.BOT_TOKEN —á–∏—Ç–∞—î—Ç—å—Å—è –∑ .env —Ñ–∞–π–ª—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
#
# –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:
# 1. Python —ñ–º–ø–æ—Ä—Ç—É—î bot.config
# 2. config.py —á–∏—Ç–∞—î .env —Ñ–∞–π–ª
# 3. Pydantic –ø–µ—Ä–µ–≤—ñ—Ä—è—î —â–æ BOT_TOKEN —î
# 4. settings.BOT_TOKEN –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω –∑ .env
#
# –ü–µ—Ä–µ–≤–∞–≥–∏:
# ‚úÖ –¢–æ–∫–µ–Ω –Ω–µ –≤ Git (–±–µ–∑–ø–µ—á–Ω–æ!)
# ‚úÖ –õ–µ–≥–∫–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ (–ø—Ä–æ—Å—Ç–æ .env)
# ‚úÖ –†—ñ–∑–Ω—ñ —Ç–æ–∫–µ–Ω–∏ –¥–ª—è dev/prod


# ========================================
# –®–ê–ì 1.2: –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start
# ========================================
async def cmd_start(message: Message):
    """
    –§—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î /start

    –ü–∞—Ä–∞–º–µ—Ç—Ä–∏:
    - message: –æ–±'—î–∫—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

    –©–æ —Ä–æ–±–∏—Ç—å:
    - –û—Ç—Ä–∏–º—É—î —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—è–∫—â–æ —î)
    - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø—Ä–∏–≤—ñ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    """
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–∞–±–æ "–¥—Ä—É–∂–µ" —è–∫—â–æ —ñ–º–µ–Ω—ñ –Ω–µ–º–∞—î)
    user_name = message.from_user.first_name or "–¥—Ä—É–∂–µ"

    # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    text = f"–ü—Ä–∏–≤—ñ—Ç, {user_name}! üëã\n\n–Ø –ø—Ä–æ—Å—Ç–∏–π –±–æ—Ç. –ü–æ–∫–∏ —â–æ –≤–º—ñ—é —Ç—ñ–ª—å–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ /start"

    # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    await message.answer(text)


# ========================================
# –®–ê–ì 1.3: –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É
# ========================================
async def main():
    """
    –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –∑–∞–ø—É—Å–∫–∞—î –±–æ—Ç–∞

    –©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:
    1. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –æ–±'—î–∫—Ç –±–æ—Ç–∞ –∑ —Ç–æ–∫–µ–Ω–æ–º
    2. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä (–æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
    3. –†–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è /start
    4. –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è polling (–±–æ—Ç –ø–æ—Å—Ç—ñ–π–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
    """

    # –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–æ—Ç–∞
    print("ü§ñ –°—Ç–≤–æ—Ä—é—é –±–æ—Ç–∞...")
    # –ö–†–û–ö 2: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–∫–µ–Ω –∑ config (–∑ .env —Ñ–∞–π–ª—É)
    bot = Bot(token=settings.BOT_TOKEN)

    # –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
    print("üì¶ –°—Ç–≤–æ—Ä—é—é –¥–∏—Å–ø–µ—Ç—á–µ—Ä...")
    dp = Dispatcher()

    # –ö—Ä–æ–∫ 3: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ /start
    print("üîß –†–µ—î—Å—Ç—Ä—É—é –æ–±—Ä–æ–±–Ω–∏–∫ /start...")
    dp.message.register(cmd_start, CommandStart())

    # –ö—Ä–æ–∫ 4: –í–∏–¥–∞–ª–µ–Ω–Ω—è webhook (—è–∫—â–æ –±—É–≤)
    print("üßπ –û—á–∏—â–∞—é webhook...")
    await bot.delete_webhook(drop_pending_updates=True)

    # –ö—Ä–æ–∫ 5: –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –±–æ—Ç–∞
    me = await bot.get_me()
    print(f"‚úÖ –ë–æ—Ç @{me.username} —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!")
    print(f"üì° –û—á—ñ–∫—É—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...\n")

    # –ö—Ä–æ–∫ 6: –ó–∞–ø—É—Å–∫ polling (–Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
    try:
        await dp.start_polling(bot)
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª –∑—É–ø–∏–Ω–∫–∏...")
    finally:
        # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Å–µ—Å—ñ—é –±–æ—Ç–∞
        await bot.session.close()
        print("üëã –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ!")


# ========================================
# –®–ê–ì 1.4: –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
# ========================================
if __name__ == "__main__":
    """
    –¶—è —á–∞—Å—Ç–∏–Ω–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∫–æ–ª–∏ –º–∏ –∑–∞–ø—É—Å–∫–∞—î–º–æ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É

    asyncio.run(main()) - –∑–∞–ø—É—Å–∫–∞—î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é main()
    """
    print("=" * 50)
    print("üåæ FERM BOT - –ö–†–û–ö 2: –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ .env")
    print("=" * 50)
    print()

    # –ö–†–û–ö 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ —Ç–µ–ø–µ—Ä –≤ config.py!
    # –Ø–∫—â–æ –Ω–µ–º–∞—î .env –∞–±–æ BOT_TOKEN - Pydantic –≤–∏–∫–∏–Ω–µ –ø–æ–º–∏–ª–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
    # –ú–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—É—î–º–æ —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é:
    print(f"üìù –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞:")
    print(f"   DEBUG = {settings.DEBUG}")
    print(f"   LOG_LEVEL = {settings.LOG_LEVEL}")
    print(f"   BOT_TOKEN = {'*' * 20}...{settings.BOT_TOKEN[-4:] if len(settings.BOT_TOKEN) > 4 else '***'}")
    print()

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    try:
        asyncio.run(main())
    except Exception as e:
        print(f"üí• –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")
        exit(1)