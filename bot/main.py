"""
–ö–†–û–ö 3: Telegram –±–æ—Ç –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º

–©–æ –Ω–æ–≤–æ–≥–æ –≤ —Ü—å–æ–º—É –∫—Ä–æ—Ü—ñ:
- ‚úÖ –ö—Ä–∞—Å–∏–≤—ñ –∫–æ–ª—å–æ—Ä–æ–≤—ñ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ (loguru)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤ —É —Ñ–∞–π–ª–∏
- ‚úÖ –†—ñ–∑–Ω—ñ —Ä—ñ–≤–Ω—ñ –ª–æ–≥—É–≤–∞–Ω–Ω—è (DEBUG, INFO, WARNING, ERROR)
- ‚úÖ –ó–∞–º—ñ—Å—Ç—å print() —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ logger

–©–æ –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ:
- ‚úÖ –ö—Ä–æ–∫ 1: –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –±–æ—Ç –∑ /start
- ‚úÖ –ö—Ä–æ–∫ 2: –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ .env —Ñ–∞–π–ª

–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫—É:
1. –§–∞–π–ª .env –∑ BOT_TOKEN (—Å—Ç–≤–æ—Ä—ñ—Ç—å –∑ .env.example)
2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ: aiogram, pydantic-settings, loguru

–Ø–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–∏:
    python -m bot.main

–ü–æ—è—Å–Ω–µ–Ω–Ω—è –∫–æ–¥—É:
- asyncio - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
- Bot, Dispatcher - –æ—Å–Ω–æ–≤–∞ aiogram
- settings - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑ config.py (—á–∏—Ç–∞—î .env)
- logger - –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ loguru (–∑–∞–º—ñ—Å—Ç—å print)
"""

import asyncio
from aiogram import Bot, Dispatcher
from aiogram.filters import CommandStart
from aiogram.types import Message

# –ö–†–û–ö 2: –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
from bot.config import settings

# –ö–†–û–ö 3: –Ü–º–ø–æ—Ä—Ç—É—î–º–æ logger
from bot.logger import logger


# ========================================
# –ö–†–û–ö 2: –¢–æ–∫–µ–Ω —Ç–µ–ø–µ—Ä –∑ .env —Ñ–∞–π–ª—É!
# ========================================
# –ë—ñ–ª—å—à–µ –Ω–µ –ø–∏—à–µ–º–æ —Ç–æ–∫–µ–Ω –≤ –∫–æ–¥—ñ!
# settings.BOT_TOKEN —á–∏—Ç–∞—î—Ç—å—Å—è –∑ .env —Ñ–∞–π–ª—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
#
# –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:
# 1. Python —ñ–º–ø–æ—Ä—Ç—É—î bot.config
# 2. config.py —á–∏—Ç–∞—î .env —Ñ–∞–π–ª
# 3. Pydantic –ø–µ—Ä–µ–≤—ñ—Ä—è—î —â–æ BOT_TOKEN —î
# 4. settings.BOT_TOKEN –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω –∑ .env
#
# –ü–µ—Ä–µ–≤–∞–≥–∏:
# ‚úÖ –¢–æ–∫–µ–Ω –Ω–µ –≤ Git (–±–µ–∑–ø–µ—á–Ω–æ!)
# ‚úÖ –õ–µ–≥–∫–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ (–ø—Ä–æ—Å—Ç–æ .env)
# ‚úÖ –†—ñ–∑–Ω—ñ —Ç–æ–∫–µ–Ω–∏ –¥–ª—è dev/prod


# ========================================
# –®–ê–ì 1.2: –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start
# ========================================
async def cmd_start(message: Message):
    """
    –§—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î /start

    –ü–∞—Ä–∞–º–µ—Ç—Ä–∏:
    - message: –æ–±'—î–∫—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

    –©–æ —Ä–æ–±–∏—Ç—å:
    - –û—Ç—Ä–∏–º—É—î —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—è–∫—â–æ —î)
    - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø—Ä–∏–≤—ñ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    - –ö–†–û–ö 3: –õ–æ–≥—É—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    """
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–∞–±–æ "–¥—Ä—É–∂–µ" —è–∫—â–æ —ñ–º–µ–Ω—ñ –Ω–µ–º–∞—î)
    user_name = message.from_user.first_name or "–¥—Ä—É–∂–µ"
    user_id = message.from_user.id

    # –ö–†–û–ö 3: –õ–æ–≥—É—î–º–æ —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ø—É—Å—Ç–∏–≤ –±–æ—Ç–∞
    logger.info(f"üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user_name} (ID: {user_id}) –≤—ñ–¥–ø—Ä–∞–≤–∏–≤ /start")

    # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    text = f"–ü—Ä–∏–≤—ñ—Ç, {user_name}! üëã\n\n–Ø –ø—Ä–æ—Å—Ç–∏–π –±–æ—Ç. –ü–æ–∫–∏ —â–æ –≤–º—ñ—é —Ç—ñ–ª—å–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ /start"

    # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    await message.answer(text)

    # –ö–†–û–ö 3: –õ–æ–≥—É—î–º–æ —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ
    logger.debug(f"‚úâÔ∏è  –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ /start –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É {user_id}")


# ========================================
# –®–ê–ì 1.3: –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É
# ========================================
async def main():
    """
    –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –∑–∞–ø—É—Å–∫–∞—î –±–æ—Ç–∞

    –©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:
    1. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –æ–±'—î–∫—Ç –±–æ—Ç–∞ –∑ —Ç–æ–∫–µ–Ω–æ–º
    2. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä (–æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
    3. –†–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è /start
    4. –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è polling (–±–æ—Ç –ø–æ—Å—Ç—ñ–π–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
    5. –ö–†–û–ö 3: –í—Å—ñ –µ—Ç–∞–ø–∏ –ª–æ–≥—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ logger
    """

    # –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–æ—Ç–∞
    logger.info("ü§ñ –°—Ç–≤–æ—Ä—é—é –±–æ—Ç–∞...")
    # –ö–†–û–ö 2: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–∫–µ–Ω –∑ config (–∑ .env —Ñ–∞–π–ª—É)
    bot = Bot(token=settings.BOT_TOKEN)

    # –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
    logger.info("üì¶ –°—Ç–≤–æ—Ä—é—é –¥–∏—Å–ø–µ—Ç—á–µ—Ä...")
    dp = Dispatcher()

    # –ö—Ä–æ–∫ 3: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ /start
    logger.info("üîß –†–µ—î—Å—Ç—Ä—É—é –æ–±—Ä–æ–±–Ω–∏–∫ /start...")
    dp.message.register(cmd_start, CommandStart())

    # –ö—Ä–æ–∫ 4: –í–∏–¥–∞–ª–µ–Ω–Ω—è webhook (—è–∫—â–æ –±—É–≤)
    logger.info("üßπ –û—á–∏—â–∞—é webhook...")
    await bot.delete_webhook(drop_pending_updates=True)

    # –ö—Ä–æ–∫ 5: –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –±–æ—Ç–∞
    me = await bot.get_me()
    logger.success(f"‚úÖ –ë–æ—Ç @{me.username} —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!")
    logger.info("üì° –û—á—ñ–∫—É—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...")

    # –ö—Ä–æ–∫ 6: –ó–∞–ø—É—Å–∫ polling (–Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
    try:
        await dp.start_polling(bot)
    except KeyboardInterrupt:
        logger.warning("‚ö†Ô∏è  –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª –∑—É–ø–∏–Ω–∫–∏ (Ctrl+C)...")
    finally:
        # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Å–µ—Å—ñ—é –±–æ—Ç–∞
        await bot.session.close()
        logger.info("üëã –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ!")


# ========================================
# –®–ê–ì 1.4: –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
# ========================================
if __name__ == "__main__":
    """
    –¶—è —á–∞—Å—Ç–∏–Ω–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∫–æ–ª–∏ –º–∏ –∑–∞–ø—É—Å–∫–∞—î–º–æ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É

    asyncio.run(main()) - –∑–∞–ø—É—Å–∫–∞—î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é main()

    –ö–†–û–ö 3: –¢–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ logger –∑–∞–º—ñ—Å—Ç—å print
    """
    # –ö–†–û–ö 3: –õ–æ–≥–µ—Ä –≤–∂–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ bot.logger
    # –ü—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ logger –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è setup_logger()

    logger.info("=" * 50)
    logger.info("üåæ FERM BOT - –ö–†–û–ö 3: –õ–æ–≥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ loguru")
    logger.info("=" * 50)

    # –ö–†–û–ö 2-3: –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ —Ç–µ–ø–µ—Ä –≤ config.py!
    # –Ø–∫—â–æ –Ω–µ–º–∞—î .env –∞–±–æ BOT_TOKEN - Pydantic –≤–∏–∫–∏–Ω–µ –ø–æ–º–∏–ª–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
    logger.info("üìù –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞:")
    logger.info(f"   DEBUG = {settings.DEBUG}")
    logger.info(f"   LOG_LEVEL = {settings.LOG_LEVEL}")
    logger.info(f"   LOG_TO_FILE = {settings.LOG_TO_FILE}")
    logger.info(f"   BOT_TOKEN = {'*' * 20}...{settings.BOT_TOKEN[-4:] if len(settings.BOT_TOKEN) > 4 else '***'}")

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        # –¶–µ –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ –≤ main(), –ø—Ä–æ—Å—Ç–æ –≤–∏—Ö–æ–¥–∏–º–æ
        pass
    except Exception as e:
        # –ö–†–û–ö 3: –õ–æ–≥—É—î–º–æ –∫—Ä–∏—Ç–∏—á–Ω—É –ø–æ–º–∏–ª–∫—É –∑ –ø–æ–≤–Ω–∏–º traceback
        logger.exception(f"üí• –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞:")
        exit(1)