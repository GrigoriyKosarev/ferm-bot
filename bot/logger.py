"""
–ö–†–û–ö 3: –õ–æ–≥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É logging

–©–æ —Ç–∞–∫–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è?
- –ó–∞–ø–∏—Å –ø–æ–¥—ñ–π —â–æ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –≤ –ø—Ä–æ–≥—Ä–∞–º—ñ
- –î–æ–ø–æ–º–∞–≥–∞—î –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É —Ç–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∏
- –ö—Ä–∞—â–µ –Ω—ñ–∂ print() –±–æ –º–æ–∂–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –≤ —Ñ–∞–π–ª–∏

–©–æ —Ç–∞–∫–µ logging?
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Python –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –í–±—É–¥–æ–≤–∞–Ω–∞ –≤ Python (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏)
- –î—É–∂–µ –≥–Ω—É—á–∫–∞ —Ç–∞ –ø–æ—Ç—É–∂–Ω–∞
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è aiogram —Ç–∞ —ñ–Ω—à–∏–º–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞–º–∏

–†—ñ–≤–Ω—ñ –ª–æ–≥—É–≤–∞–Ω–Ω—è (–≤—ñ–¥ –Ω–∞–π–º–µ–Ω—à –¥–æ –Ω–∞–π–±—ñ–ª—å—à –≤–∞–∂–ª–∏–≤–∏—Ö):
- DEBUG (10): –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ª–∞–¥–∫–∏ (–±–∞–≥–∞—Ç–æ —Ç–µ–∫—Å—Ç—É!)
- INFO (20): –ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ä–æ–±–æ—Ç—É (–Ω–æ—Ä–º–∞)
- WARNING (30): –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è (—â–æ—Å—å –Ω–µ–∑–≤–∏—á–Ω–µ, –∞–ª–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–µ)
- ERROR (40): –ü–æ–º–∏–ª–∫–∞ (—â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫)
- CRITICAL (50): –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ (–ø—Ä–æ–≥—Ä–∞–º–∞ –Ω–µ –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏)

–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
    from bot.logger import logger

    logger.debug("–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞")
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ")
    logger.warning("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤—ñ–≤ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –¥–∞–Ω—ñ")
    logger.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å –¥–æ –ë–î")
    logger.critical("–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞, –±–æ—Ç –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è")
"""

import logging
import sys
from pathlib import Path
from logging.handlers import RotatingFileHandler

from bot.config import settings, PROJECT_ROOT


# ========================================
# –ö–û–õ–¨–û–†–ò –î–õ–Ø –ö–û–ù–°–û–õ–Ü (ANSI –∫–æ–¥–∏)
# ========================================
class ColoredFormatter(logging.Formatter):
    """
    –§–æ—Ä–º–∞—Ç—Ç–µ—Ä —è–∫–∏–π –¥–æ–¥–∞—î –∫–æ–ª—å–æ—Ä–∏ –¥–æ –ª–æ–≥—ñ–≤ —É –∫–æ–Ω—Å–æ–ª—ñ

    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î ANSI escape –∫–æ–¥–∏ –¥–ª—è –∫–æ–ª—å–æ—Ä—ñ–≤:
    - \033[XXm - –ø–æ—á–∞—Ç–æ–∫ –∫–æ–ª—å–æ—Ä—É
    - \033[0m - —Å–∫–∏–¥–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É
    """

    # ANSI –∫–æ–¥–∏ –∫–æ–ª—å–æ—Ä—ñ–≤
    COLORS = {
        'DEBUG': '\033[36m',      # Cyan (–±–ª–∞–∫–∏—Ç–Ω–∏–π)
        'INFO': '\033[32m',       # Green (–∑–µ–ª–µ–Ω–∏–π)
        'WARNING': '\033[33m',    # Yellow (–∂–æ–≤—Ç–∏–π)
        'ERROR': '\033[31m',      # Red (—á–µ—Ä–≤–æ–Ω–∏–π)
        'CRITICAL': '\033[35m',   # Magenta (–ø—É—Ä–ø—É—Ä–Ω–∏–π)
    }
    RESET = '\033[0m'             # –°–∫–∏–¥–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É

    def format(self, record):
        """
        –§–æ—Ä–º–∞—Ç—É—î –ª–æ–≥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–æ–ª—å–æ—Ä–∞–º–∏

        record - –æ–±'—î–∫—Ç LogRecord –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –ª–æ–≥
        """
        # –í–ê–ñ–õ–ò–í–û: –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π levelname
        # —â–æ–± –Ω–µ –≤–ø–ª–∏–≤–∞—Ç–∏ –Ω–∞ —ñ–Ω—à—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ (file_handler)
        original_levelname = record.levelname

        # –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–ª—ñ—Ä –¥–ª—è —Ä—ñ–≤–Ω—è –ª–æ–≥—É
        log_color = self.COLORS.get(record.levelname, self.RESET)

        # –î–æ–¥–∞—î–º–æ –∫–æ–ª—å–æ—Ä–∏ –¥–æ levelname
        record.levelname = f"{log_color}{record.levelname:8}{self.RESET}"

        # –§–æ—Ä–º–∞—Ç—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        result = super().format(record)

        # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π levelname –¥–ª—è —ñ–Ω—à–∏—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
        record.levelname = original_levelname

        return result


# ========================================
# –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –õ–û–ì–£–í–ê–ù–ù–Ø
# ========================================
def setup_logger():
    """
    –ù–∞–ª–∞—à—Ç–æ–≤—É—î –ª–æ–≥–µ—Ä –∑ –¥–≤–æ–º–∞ –≤–∏—Ö–æ–¥–∞–º–∏:
    1. –ö–æ–Ω—Å–æ–ª—å (stdout) - –∫–æ–ª—å–æ—Ä–æ–≤—ñ –ª–æ–≥–∏ –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞
    2. –§–∞–π–ª logs/bot.log - –≤—Å—ñ –ª–æ–≥–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É

    –©–æ —Ä–æ–±–∏—Ç—å —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è:
    - –°—Ç–≤–æ—Ä—é—î logger –∑ –Ω–∞–∑–≤–æ—é 'bot'
    - –í—Å—Ç–∞–Ω–æ–≤–ª—é—î —Ä—ñ–≤–µ–Ω—å –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ .env
    - –î–æ–¥–∞—î –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª—ñ (–∑ –∫–æ–ª—å–æ—Ä–∞–º–∏)
    - –î–æ–¥–∞—î –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ñ–∞–π–ª—É (–∑ —Ä–æ—Ç–∞—Ü—ñ—î—é)
    """

    # ========================================
    # –ö–†–û–ö 1: –°—Ç–≤–æ—Ä—é—î–º–æ –∞–±–æ –æ—Ç—Ä–∏–º—É—î–º–æ logger
    # ========================================
    logger = logging.getLogger('bot')

    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä—ñ–≤–µ–Ω—å –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ .env
    # getattr –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î "INFO" –≤ logging.INFO
    log_level = getattr(logging, settings.LOG_LEVEL.upper(), logging.INFO)
    logger.setLevel(log_level)

    # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ —è–∫—â–æ —î (—â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏)
    if logger.handlers:
        logger.handlers.clear()

    # ========================================
    # –ö–†–û–ö 2: –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è –ª–æ–≥—ñ–≤
    # ========================================
    # –§–æ—Ä–º–∞—Ç: 2025-12-15 14:30:00 | INFO     | bot.main:main:98 - –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    log_format = (
        '%(asctime)s | '
        '%(levelname)s | '
        '%(name)s:%(funcName)s:%(lineno)d - '
        '%(message)s'
    )
    date_format = '%Y-%m-%d %H:%M:%S'

    # ========================================
    # –ö–†–û–ö 3: –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –ö–û–ù–°–û–õ–Ü (–∑ –∫–æ–ª—å–æ—Ä–∞–º–∏)
    # ========================================
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(log_level)

    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ColoredFormatter –¥–ª—è –∫–æ–ª—å–æ—Ä–æ–≤–∏—Ö –ª–æ–≥—ñ–≤
    colored_formatter = ColoredFormatter(log_format, date_format)
    console_handler.setFormatter(colored_formatter)

    logger.addHandler(console_handler)

    # ========================================
    # –ö–†–û–ö 4: –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –§–ê–ô–õ–£ (—è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ)
    # ========================================
    if settings.LOG_TO_FILE:
        # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è –ª–æ–≥—ñ–≤ —è–∫—â–æ —ó—ó –Ω–µ–º–∞—î
        logs_dir = PROJECT_ROOT / "logs"
        logs_dir.mkdir(exist_ok=True)

        # RotatingFileHandler - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π —Ñ–∞–π–ª –∫–æ–ª–∏ —Å—Ç–∞—Ä–∏–π –¥–æ—Å—è–≥–Ω–µ maxBytes
        file_handler = RotatingFileHandler(
            filename=logs_dir / "bot.log",
            maxBytes=10 * 1024 * 1024,  # 10 MB (10 –º–µ–≥–∞–±–∞–π—Ç)
            backupCount=5,               # –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ 5 —Å—Ç–∞—Ä–∏—Ö —Ñ–∞–π–ª—ñ–≤ (bot.log.1, bot.log.2, ...)
            encoding='utf-8',
        )
        file_handler.setLevel(log_level)

        # –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è —Ñ–∞–π–ª—É –ë–ï–ó –∫–æ–ª—å–æ—Ä—ñ–≤ (–∫–æ–ª—å–æ—Ä–∏ –≤ —Ñ–∞–π–ª–∞—Ö –≤–∏–≥–ª—è–¥–∞—é—Ç—å —è–∫ –∫–æ–¥)
        file_formatter = logging.Formatter(log_format, date_format)
        file_handler.setFormatter(file_formatter)

        logger.addHandler(file_handler)

        logger.info(f"üìÅ –õ–æ–≥–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤: {logs_dir / 'bot.log'}")

    # ========================================
    # –ö–†–û–ö 5: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è aiogram
    # ========================================
    # aiogram –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å–≤—ñ–π logger, –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –π–æ–º—É —Ç–æ–π —Å–∞–º–∏–π —Ä—ñ–≤–µ–Ω—å
    aiogram_logger = logging.getLogger('aiogram')
    aiogram_logger.setLevel(log_level)

    # ========================================
    # –ö–†–û–ö 6: –Ü–Ω—Ñ–æ—Ä–º—É—î–º–æ –ø—Ä–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    # ========================================
    logger.info(f"üîß –õ–æ–≥–µ—Ä –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ | –†—ñ–≤–µ–Ω—å: {settings.LOG_LEVEL}")

    if settings.DEBUG:
        logger.warning("‚ö†Ô∏è  DEBUG —Ä–µ–∂–∏–º —É–≤—ñ–º–∫–Ω–µ–Ω–æ!")

    return logger


# ========================================
# –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ü–†–ò –Ü–ú–ü–û–†–¢–Ü
# ========================================
# –ö–æ–ª–∏ —Ö—Ç–æ—Å—å —Ä–æ–±–∏—Ç—å "from bot.logger import logger"
# –õ–æ–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–ª–∞—à—Ç—É—î—Ç—å—Å—è
logger = setup_logger()


# ========================================
# –ü–†–ò–ö–õ–ê–î–ò –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø
# ========================================
"""
–í —ñ–Ω—à–∏—Ö —Ñ–∞–π–ª–∞—Ö –ø—Ä–æ—Å—Ç–æ —ñ–º–ø–æ—Ä—Ç—É–π—Ç–µ logger:

    from bot.logger import logger

    # –†—ñ–∑–Ω—ñ —Ä—ñ–≤–Ω—ñ –ª–æ–≥—É–≤–∞–Ω–Ω—è:
    logger.debug("–¶–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–ª–∞–¥–∫–∏")
    logger.info("–¶–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è")
    logger.warning("–¶–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è")
    logger.error("–¶–µ –ø–æ–º–∏–ª–∫–∞")
    logger.critical("–¶–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞")

    # –õ–æ–≥—É–≤–∞–Ω–Ω—è –∑ –∑–º—ñ–Ω–Ω–∏–º–∏:
    user_id = 12345
    logger.info(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user_id} –∑–∞–ø—É—Å—Ç–∏–≤ –±–æ—Ç–∞")

    # –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –∑ traceback:
    try:
        result = 10 / 0
    except Exception as e:
        logger.exception("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥—ñ–ª–µ–Ω–Ω—ñ:")  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—Å—Ç—å traceback

–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ .env:
    # –†—ñ–≤–µ–Ω—å –ª–æ–≥—É–≤–∞–Ω–Ω—è (DEBUG, INFO, WARNING, ERROR, CRITICAL)
    LOG_LEVEL=INFO

    # –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –ª–æ–≥–∏ —É —Ñ–∞–π–ª? (True/False)
    LOG_TO_FILE=True

    # –†–µ–∂–∏–º –≤—ñ–¥–ª–∞–¥–∫–∏ (–±—ñ–ª—å—à–µ –ª–æ–≥—ñ–≤)
    DEBUG=False

–ü–µ—Ä–µ–≤–∞–≥–∏ logging –ø–µ—Ä–µ–¥ print():
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ —Ñ–∞–π–ª–∏
‚úÖ –ö–æ–ª—å–æ—Ä–æ–≤—ñ –ª–æ–≥–∏ (–ª–µ–≥–∫–æ –ø–æ–º—ñ—Ç–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∏)
‚úÖ –ß–∞—Å –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
‚úÖ –Ü–º'—è —Ñ–∞–π–ª—É —Ç–∞ –Ω–æ–º–µ—Ä —Ä—è–¥–∫–∞
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–æ—Ç–∞—Ü—ñ—è (—Ñ–∞–π–ª–∏ –Ω–µ —Ä–æ—Å—Ç—É—Ç—å –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ)
‚úÖ –†—ñ–∑–Ω—ñ —Ä—ñ–≤–Ω—ñ –≤–∞–∂–ª–∏–≤–æ—Å—Ç—ñ
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π traceback –¥–ª—è –ø–æ–º–∏–ª–æ–∫
‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Python (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏)
"""
